# QuantumPurse
Quantum Purse is a front-end for the [CKB quantum resistant lock script project](https://github.com/cryptape/quantum-resistant-lock-script) that utilizes SPHINCS+ (remaned to fips205) signature scheme. It provides a tool set that allows users to generate/import BIP39 style mnemonic seed phrase, to create accounts and to sign CKB transaction (now limited to transfer only). CKB addresses generated by Quantum Purse are quantum safe and by transferring your asset to these addresses, your assets become Quantum Safe.

#### Illustration
```
+------------------+
|     Frontend     |  - User interacts here.
+------------------+
         ^
         |
         v
+------------------+
|  QuantumPurse.ts |  - Manages wallet logic (e.g., addresses, balances, transactions).
+------------------+
         ^
         |
         v
+------------------+
|   KeyVault(WASM) |  - Processes all key operations in a sandboxed environment:
|                  |    * Generates BIP39 mnemonic.
|                  |    * Derives SPHINCS+ key pairs..
|                  |    * Encrypts, Decrypts and signs transactions.
+------------------+
         ^
         |
         v
+------------------+
|    IndexedDB     |  - Stores sensitive data, always encrypted:
|                  |    * Encrypted BIP39 mnemonic.
|                  |    * Encrypted SPHINCS+ key pairs.
+------------------+
```
#### Indexed DB store model:

```
+---------------------------------+
|    seed_phrase_store(single)    |
+---------------------------------+
|  Key: "seed_phrase"             |
|  Value: CipherPayload           |
|        - salt: String           |
|        - iv: String             |
|        - cipher_text: String    |
+---------------------------------+


+---------------------------------+
|    child_keys_store(multiple)   |
+---------------------------------+
|  Key: pub_key (String)          |
|  Value: SphincsPlusKeyPair      |
|        - index: u32             |
|        - pub_key: String        |
|        - pri_enc: CipherPayload |
+---------------------------------+
```

## Prerequisited
1. Rust and Cargo, follow [this link](https://doc.rust-lang.org/cargo/getting-started/installation.html#:~:text=Install%20Rust%20and%20Cargo,rustup%20will%20also%20install%20cargo%20.) for installation.
2. wasm-pack, execute: `cargo install wasm-pack`.
3. Docker Engine/Desktop.
4. Node.

## How to use

```shell
# Install all dependencies
npm install

# Run test
npm run test

# Run in development env
npm run start

# Build a production package
npm run build

# Deploy the web app to your github
npm run deploy
```

## Example code.
Below is a sample code snippet demonstrating how to import a seed phrase to quantum purse wallet in src/index.ts:
```typescript
import "./styles.css";
import Icon from "./icon.png";
import { transfer } from "./core/transaction_builder";
import { sendTransaction } from "./core/utils";
import { NODE_URL } from "./core/config";
import QuantumPurse from "./core/quantum_purse";
import { utf8ToBytes, bytesToUtf8 } from "./core/utils";

// Add title
const text = "A quantum resistant wallet for ckb blockchain";
const $content = document.querySelector("#content");
if ($content) {
  $content.textContent = text;
}

// Add the icon
const myIcon = new Image();
myIcon.src = Icon;
document.body.appendChild(myIcon);

// Helper function to create a delay
function delay(ms:any) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/////////////////////////////////////////////////////////////////////
async function run() {
  const passwordStr = "my password is easy to crack. Don't use this!";
  try {
    const wallet = await QuantumPurse.getInstance();

    // await wallet.dbClear();

    // importing a seed phrase
    const newSeed = "ball slush siren skirt local odor gather settle green remind orphan keep vapor comfort hen wave conduct phrase torch address hungry clerk caught vessel";
    await wallet.importSeedPhrase(utf8ToBytes(newSeed), utf8ToBytes(passwordStr));

    // export to see the seed phrase + gen first account
    const seed = await wallet.exportSeedPhrase(utf8ToBytes(passwordStr)); // !! remember to clear seed !!
    console.log("imported seed: ", bytesToUtf8(seed));
    // await wallet.genAccount(utf8ToBytes(passwordStr)); // gen and encrypt a child key; input password is gone from here

    // get accounts list
    const accountList = await wallet.getAllAccounts();
    console.log("account_list: ", accountList);

    // set account pointer to account 0
    await wallet.setAccPointer(accountList[0]);
    const address0 = await wallet.getAddress();
    console.log("address0: ", address0);

    // get balance
    const balance = await wallet.getBalance();
    console.log("balance: ", balance/100000000n, "CKB");



    // test light client
    // Wait for 10 seconds before executing the sync status check
    await delay(5000);

    const status = await QuantumPurse.getSyncStatusFromWorker();
    console.log(">>> sync_status: ", status);
    const newBalance = await wallet.getBalanceN(accountList[0]);
    console.log("newBalance: ", newBalance/100000000n, "CKB");

    // build transaction and send
    const tx = await transfer(address0, address0, "333");
    const signedTx = await wallet.sign(tx, utf8ToBytes(passwordStr));
    // console.log(">>>signedTx: ", JSON.stringify(signedTx, null, 2))
    const txId = await wallet.sendTransaction(signedTx);
    console.log(">>>tx_id: ", txId);

  } catch (error) {
    console.error("ERROR:", error);
  }
}

run();
/////////////////////////////////////////////////////////////////////
```